<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.1',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="leftjs&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="leftjs&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="leftjs&#39;s Blog">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>leftjs's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">leftjs's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/19/InfluxDB 存储/InfluxDB存储/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leftjs's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/19/InfluxDB 存储/InfluxDB存储/" itemprop="url">
                  Influx 存储
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-09-19 16:18:43 / Modified: 21:03:20" itemprop="dateCreated datePublished" datetime="2018-09-19T16:18:43+08:00">2018-09-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="InfluxDB"><a href="#InfluxDB" class="headerlink" title="InfluxDB"></a>InfluxDB</h1><p>InfluxDB 在 DB-Engines 的时序数据库类别里排名第一，实至名归，从它的功能丰富性、易用性以及底层实现来看，都有很多的亮点，值得大篇幅来分析。</p>
<p>首先简单归纳下它的几个比较重要的特性：</p>
<ol>
<li><strong>极简架构</strong>：单机版的 InfluxDB 只需要安装一个 binary，即可运行使用，完全没有任何的外部依赖。相比来看几个反面例子，OpenTSDB 底层是 HBase，拖家带口就得带上 ZooKeeper、HDFS 等，如果你不熟悉 Hadoop 技术栈，一般运维起来是有一定的难度，这也是其被人抱怨最多的一个点。KairosDB 稍微好点，它依赖 Cassandra 和 ZooKeeper，单机测试可以使用 H2。总的来说，依赖一个外部的分布式数据库的 TSDB，在架构上会比完全自包含的 TSDB 复杂一点，毕竟一个成熟的分布式数据库本身就很复杂，当然这一点在云计算这个时代已经完全消除。</li>
<li><strong>TSM Engine</strong>：底层采用自研的 TSM 存储引擎，TSM 也是基于 LSM 的思想，提供极强的写能力以及高压缩率，在后面的章节会对其做一个比较详细的分析。</li>
<li><strong>InfluxQL</strong>：提供 SQL-Like 的查询语言，极大的方便了使用，数据库在易用性上演进的终极目标都是提供 Query Language。</li>
<li><strong>Continuous Queries</strong>: 通过 CQ 能够支持 auto-rollup 和 pre-aggregation，对常见的查询操作可以通过 CQ 来预计算加速查询。</li>
<li><strong>TimeSeries Index</strong>: 对 Tags 会进行索引，提供高效的检索。这一项功能，对比 OpenTSDB 和 KairosDB 等，在 Tags 检索的效率上提升了不少。OpenTSDB 在 Tags 检索上做了不少的查询优化，但是受限于 HBase 的功能和数据模型，所以然并卵。不过目前稳定版中的实现采用的是 memory-based index 的实现方式，这种方案在实现上比较简单，查询上效率最高，但是带来了不少的问题，在下面的章节会详细描述。</li>
<li><strong>Plugin Support</strong>: 支持自定义插件，能够扩展到兼容多种协议，如 Graphite、collectd 和 OpenTSDB。</li>
</ol>
<h1 id="TSM"><a href="#TSM" class="headerlink" title="TSM"></a>TSM</h1><p>InfluxDB 底层的存储引擎经历了从 LevelDB 到 BlotDB，再到选择自研 TSM 的过程，整个选择转变的思考可以在其官网文档里看到。整个思考过程很值得借鉴，对技术选型和转变的思考总是比平白的描述某个产品特性让人印象深刻的多。</p>
<p>我简单总结下它的整个存储引擎选型转变的过程，第一阶段是 LevelDB，选型 LevelDB 的主要原因是其底层数据结构采用 LSM，对写入很友好，能够提供很高的写入吞吐量，比较符合时序数据的特性。在 LevelDB 内，数据是采用 KeyValue 的方式存储且按 Key 排序，InfluxDB 使用的 Key 设计是 SeriesKey+Timestamp 的组合，所以相同 SeriesKey 的数据是按 timestamp 来排序存储的，能够提供很高效的按时间范围的扫描。</p>
<p>不过使用 LevelDB 的一个最大的问题是，InfluxDB 支持历史数据自动删除（Retention Policy），在时序数据场景下数据自动删除通常是大块的连续时间段的历史数据删除。LevelDB 不支持 Range delete 也不支持 TTL，所以要删除只能是一个一个 key 的删除，会造成大量的删除流量压力，且在 LSM 这种数据结构下，真正的物理删除不是即时的，在 compaction 时才会生效。各类 TSDB 实现数据删除的做法大致分为两类：</p>
<ol>
<li><strong>数据分区</strong>：按不同的时间范围划分为不同的分区（Shard），因为时序数据写入都是按时间线性产生的，所以分区的产生也是按时间线性增长的，写入通常是在最新的分区，而不会散列到多个分区。分区的优点是数据回收的物理删除非常简单，直接把整个分区删除即可。缺点是数据回收的精细度比较大，为整个分区，而回收的时间精度取决于分区的时间跨度。分区的实现可以是在应用层提供，也可以是存储引擎层提供，例如可以利用 RocksDB 的 column family 来作为数据分区。InfluxDB 采用这种模式，默认的 Retention Policy 下数据会以 7 天时间跨度组成为一个分区。</li>
<li><strong>TTL</strong>：底层数据引擎直接提供数据自动过期的功能，可以为每条数据设定存储时间（time to live），当数据存活时间到达后存储引擎会自动对数据进行物理删除。这种方式的优点是数据回收的精细度很高，精细到秒级及行级的数据回收。缺点是 LSM 的实现上，物理删除发生在 compaction 的时候，比较不及时。RocksDB、HBase、Cassandra 和阿里云表格存储都提供数据 TTL 的功能。</li>
</ol>
<p>InfluxDB 采用的是第一种策略，会按 7 天一个周期，将数据分为多个不同的 Shard，每个 Shard 都是一个独立的数据库实例。随着运行时间的增长，shard 的个数会越来越多。而由于每个 shard 都是一个独立的数据库实例，底层都是一套独立的 LevelDB 存储引擎，这时带来的问题是，每个存储引擎都会打开比较多的文件，随着 shard 的增多，最终进程打开的文件句柄会很快触及到上限。LevelDB 底层采用 level compaction 策略，是文件数多的原因之一。实际上 level compaction 策略不适合时序数据这种写入模式，这点原因 InfluxDB 没有提及。</p>
<p>由于遇到大量的客户反馈文件句柄过多的问题，InfluxDB 在新版本的存储引擎选型中选择了 BoltDB 替换 LevelDB。BoltDB 底层数据结构是 mmap B+树，其给出的选型理由是：1.与 LevelDB 相同语义的 API；2.纯 Go 实现，便于集成和跨平台；3.单个数据库只使用一个文件，解决了文件句柄消耗过多的问题，这条是他们选型 BoltDB 的最主要理由。但是 BoltDB 的 B+树结构与 LSM 相比，在写入能力上是一个弱势，B+树会产生大量的随机写。所以 InfluxDB 在使用 BoltDB 之后，很快遇到了 IOPS 的问题，当数据库大小达到几个 GB 后，会经常遇到 IOPS 的瓶颈，极大影响写入能力。虽然 InfluxDB 后续也采用了一些写入优化措施，例如在 BoltDB 之前加了一层 WAL，数据写入先写 WAL，WAL 能保证数据是顺序写盘，但是最终写入 BoltDB 还是会带来比较大的 IOPS 资源消耗。</p>
<p>InfluxDB 在经历了几个小版本的 BoltDB 后，最终决定自研 TSM，TSM 的设计目标一是解决 LevelDB 的文件句柄过多问题，二是解决 BoltDB 的写入性能问题。TSM 全称是 Time-Structured Merge Tree，思想类似 LSM，不过是基于时序数据的特性做了一些特殊的优化。来看下 TSM 的一些重要组件：</p>
<ol>
<li><strong>Write Ahead Log(WAL)</strong> : 数据会先写入 WAL，后进入 memory-index 和 cache，写入 WAL 会同步刷盘，保证数据持久化。Cache 内数据会异步刷入 TSM File，在 Cache 内数据未持久化到 TSM File 之前若遇到进程 crash，则会通过 WAL 内的数据来恢复 cache 内的数据，这个行为与 LSM 是完全类似的。</li>
<li><strong>Cache</strong>: TSM 的 Cache 与 LSM 的 MemoryTable 类似，其内部的数据为 WAL 中未持久化到 TSM File 的数据。若进程发生 failover，则 cache 中的数据会根据 WAL 中的数据进行重建。Cache 内数据保存在一个 SortedMap 中，Map 的 Key 为 TimeSeries+Timestamp 的组成。所以可以看到，在内存中数据是按 TimeSeries 组织的，TimeSeries 中的数据按时间顺序存放。</li>
<li><strong>TSM Files</strong>: TSM File 与 LSM 的 SSTable 类似，TSM File 由四个部分组成，分别为：header, blocks, index 和 footer。其中最重要的部分是 blocks 和 index：<ul>
<li><strong>Block</strong>：每个 block 内存储的是某个 TimeSeries 的一段时间范围内的值，即某个时间段下某个 measurement 的某组 tag set 对应的某个 field 的所有值，Block 内部会根据 field 的不同的值的类型采取不同的压缩策略，以达到最优的压缩效率。</li>
<li><strong>Index</strong>：文件内的索引信息保存了每个 TimeSeries 下所有的数据 Block 的位置信息，索引数据按 TimeSeries 的 Key 的字典序排序。在内存中不会把完整的 index 数据加载进去，这样会很大，而是只对部分 Key 做索引，称之为 indirectIndex。indirectIndex 中会有一些辅助定位的信息，例如该文件中的最小最大时间以及最小最大 Key 等，最重要的是保存了部分 Key 以及其 Index 数据的文件 offset 信息。若想要定位某个 TimeSeries 的 Index 数据，会先根据内存中的部分 Key 信息找到与其最相近的 Index Offset，之后从该起点开始顺序扫描文件内容再精确定位到该 Key 的 Index 数据位置。</li>
</ul>
</li>
<li><p><strong>Compaction</strong>: compaction 是一个将 write-optimized 的数据存储格式优化为 read-optimized 的数据存储格式的一个过程，是 LSM 结构存储引擎做存储和查询优化很重要的一个功能，compaction 的策略和算法的优劣决定了存储引擎的质量。在时序数据的场景下，基本很少发生 update 或者 delete，数据都是按时间顺序生成的，所以基本不会有 overlap，Compaction 起到的作用主要在于压缩和索引优化。</p>
<ul>
<li><strong>LevelCompaction</strong>: InfluxDB 将 TSM 文件分为 4 个层级(Level 1-4)，compaction 只会发生在同层级文件内，同层级的文件 compaction 后会晋升到下一层级。从这个规则看，根据时序数据的产生特性，level 越高数据生成时间越旧，访问热度越低。由 Cache 数据初次生成的 TSM 文件称为 Snapshot，多个 Snapshot 文件 compaction 后产生 Level1 的 TSM 文件，Level1 的文件 compaction 后生成 level2 的文件，依次类推。低 Level 和高 Level 的 compaction 会采用不同的算法，低 level 文件的 compaction 采用低 CPU 消耗的做法，例如不会做解压缩和 block 合并，而高 level 文件的 compaction 则会做 block 解压缩以及 block 合并，以进一步提高压缩率。我理解这种设计是一种权衡，compaction 通常在后台工作，为了不影响实时的数据写入，对 compaction 消耗的资源是有严格的控制，资源受限的情况下必然会影响 compaction 的速度。而 level 越低的数据越新，热度也越高，需要有一种更快的加速查询的 compaction，所以 InfluxDB 在低 level 采用低资源消耗的 compaction 策略，这完全是贴合时序数据的写入和查询特性来设计的。</li>
<li><strong>IndexOptimizationCompaction</strong>: 当 Level4 的文件积攒到一定个数后，index 会变得很大，查询效率会变的比较低。影响查询效率低的因素主要在于同一个 TimeSeries 数据会被多个 TSM 文件所包含，所以查询不可避免的需要跨多个文件进行数据整合。所以 IndexOptimizationCompaction 的主要作用就是将同一 TimeSeries 下的数据合并到同一个 TSM 文件中，尽量减少不同 TSM 文件间的 TimeSeries 重合度。</li>
<li><strong>FullCompaction</strong>: InfluxDB 在判断某个 Shard 长时间内不会再有数据写入之后，会对数据做一次 FullCompaction。FullCompaction 是 LevelCompaction 和 IndexOptimization 的整合，在做完一次 FullCompaction 之后，这个 Shard 不会再做任何的 compaction，除非有新的数据写入或者删除发生。这个策略是对冷数据的一个规整，主要目的在于提高压缩率。</li>
</ul>
</li>
</ol>
<h1 id="TimeSeries-Index"><a href="#TimeSeries-Index" class="headerlink" title="TimeSeries Index"></a>TimeSeries Index</h1><p>时序数据库除了支撑时序数据的存储和计算外，还需要能够提供多维度查询。InfluxDB 为了提供更快速的多维查询，对 TimeSeries 进行了索引。关于数据和索引，InfluxDB 是这么描述自己的：</p>
<blockquote>
<p>InfluxDB actually looks like two databases in one: a time series data store and an inverted index for the measurement, tag, and field metadata.</p>
</blockquote>
<p>在 InfluxDB 1.3 之前，TimeSeries Index(下面简称为 TSI)只支持 Memory-based 的方式，即所有的 TimeSeries 的索引都是放在内存内，这种方式有好处但是也会带来很多的问题。而在最新发布的 InfluxDB 1.3 版本上，提供了另外一种方式的索引可供选择，新的索引方式会把索引存储在磁盘上，效率上相比内存索引差一点，但是解决了内存索引存在的不少问题。</p>
<h2 id="Memory-based-Index"><a href="#Memory-based-Index" class="headerlink" title="Memory-based Index"></a>Memory-based Index</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Measurement represents a collection of time series in a database. It also</span></span><br><span class="line">    <span class="comment">// contains in memory structures for indexing tags. Exported functions are</span></span><br><span class="line">    <span class="comment">// goroutine safe while un-exported functions assume the caller will use the</span></span><br><span class="line">    <span class="comment">// appropriate locks.</span></span><br><span class="line">    <span class="keyword">type</span> Measurement <span class="keyword">struct</span> &#123;</span><br><span class="line">     database <span class="keyword">string</span></span><br><span class="line">     Name     <span class="keyword">string</span> <span class="string">`json:"name,omitempty"`</span></span><br><span class="line">     name     []<span class="keyword">byte</span> <span class="comment">// cached version as []byte</span></span><br><span class="line"></span><br><span class="line">     mu         sync.RWMutex</span><br><span class="line">     fieldNames <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// in-memory index fields</span></span><br><span class="line">     seriesByID          <span class="keyword">map</span>[<span class="keyword">uint64</span>]*Series              <span class="comment">// lookup table for series by their id</span></span><br><span class="line">     seriesByTagKeyValue <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]SeriesIDs <span class="comment">// map from tag key to value to sorted set of series ids</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// lazyily created sorted series IDs</span></span><br><span class="line">     sortedSeriesIDs SeriesIDs <span class="comment">// sorted list of series IDs in this measurement</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Series belong to a Measurement and represent unique time series in a database.</span></span><br><span class="line">    <span class="keyword">type</span> Series <span class="keyword">struct</span> &#123;</span><br><span class="line">     mu          sync.RWMutex</span><br><span class="line">     Key         <span class="keyword">string</span></span><br><span class="line">     tags        models.Tags</span><br><span class="line">     ID          <span class="keyword">uint64</span></span><br><span class="line">     measurement *Measurement</span><br><span class="line">     shardIDs    <span class="keyword">map</span>[<span class="keyword">uint64</span>]<span class="keyword">struct</span>&#123;&#125; <span class="comment">// shards that have this series defined</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如上是 InfluxDB 1.3 的源码中对内存索引数据结构的定义，主要有两个重要的数据结构体：</p>
<p><strong>Series</strong>: 对应某个 TimeSeries，其内存储 TimeSeries 相关的一些基本属性以及它所属的 Shard</p>
<ul>
<li>Key：对应 measurement + tags 序列化后的字符串。</li>
<li>tags: 该 TimeSeries 下所有的 TagKey 和 TagValue</li>
<li>ID: 用于唯一区分的整数 ID。</li>
<li>measurement: 所属的 measurement。</li>
<li>shardIDs: 所有包含该 Series 的 ShardID 列表。</li>
</ul>
<p><strong>Measurement</strong>: 每个 measurement 在内存中都会对应一个 Measurement 结构，其内部主要是一些索引来加速查询。</p>
<ul>
<li>seriesByID：通过 SeriesID 查询 Series 的一个 Map。</li>
<li>seriesByTagKeyValue：双层 Map，第一层是 TagKey 对应其所有的 TagValue，第二层是 TagValue 对应的所有 Series 的 ID。可以看到，当 TimeSeries 的基数变得很大，这个 map 所占的内存会相当多。</li>
<li>sortedSeriesIDs：一个排序的 SeriesID 列表。</li>
</ul>
<p>全内存索引结构带来的好处是能够提供非常高效的多维查询，但是相应的也会存在一些问题：</p>
<ul>
<li>能够支持的 TimeSeries 基数有限，主要受限于内存的大小。若 TimeSeries 个数超过上限，则整个数据库会处于不可服务的状态。这类问题一般由用户错误的设计 TagKey 引发，例如某个 TagKey 是一个随机的 ID。一旦遇到这个问题的话，也很难恢复，往往只能通过手动删数据。</li>
<li>若进程重启，恢复数据的时间会比较长，因为需要从所有的 TSM 文件中加载全量的 TimeSeries 信息来在内存中构建索引。</li>
</ul>
<h2 id="Disk-based-Index"><a href="#Disk-based-Index" class="headerlink" title="Disk-based Index"></a>Disk-based Index</h2><p>针对全内存索引存在的这些问题，InfluxDB 在最新的 1.3 版本中提供了另外一种索引的实现。得益于代码设计上良好的扩展性，索引模块和存储引擎模块都是插件化的，用户可以在配置中自由选择使用哪种索引。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/27/ubuntu下使用pptpd搭建vpn-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leftjs's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/27/ubuntu下使用pptpd搭建vpn-server/" itemprop="url">
                  ubuntu下使用pptpd搭建vpn-server
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-11-27 12:58:48" itemprop="dateCreated datePublished" datetime="2016-11-27T12:58:48+08:00">2016-11-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-09-15 20:01:45" itemprop="dateModified" datetime="2018-09-15T20:01:45+08:00">2018-09-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/零碎的记录/" itemprop="url" rel="index"><span itemprop="name">零碎的记录</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>由于桂电实验室上网需要 <strong>高额的</strong> 费用，考虑到实验室和宿舍的网络都是基于校园网来进行内网连接的，基于这一点，考虑在宿舍通过笔记本或树莓派设备来启动一个vpn服务器连接内网，然后再在宿舍的设备上将内外网进行桥接，即该设备可以同时上内外网，由于大多数笔记本或者树莓派都具有双网卡，所以采用无线网卡来接入一个已经具备上网功能的路由器，使用有线网卡连接内网。</p>
<blockquote>
<p>2016-12-15 update<br>最近又被2.4g网络恶心到了，宿舍那边的无线信号真的是太多了，各种信道拥堵，而英产树莓派又不支持<strong>伟大的</strong>13信道和大陆5g频段，所以ping一直都有波动，考虑买大陆的usb无线网卡或有线网卡来接入5g网络或者有线网路提高树莓派外网连接的稳定性，当然宿舍不缺电(桂电宿舍普通用电还要自己交钱,无力吐槽)准备使用笔记本搭建的童鞋当我没说，因为新一点的笔记本都支持5g吧….</p>
</blockquote>
<h2 id="配置-永不掉线-的路由器"><a href="#配置-永不掉线-的路由器" class="headerlink" title="配置 永不掉线 的路由器"></a>配置 <em>永不掉线</em> 的路由器</h2><p>桂电宿舍的网线都是单网线三网通用的，其实原理很简单，就是在上层做了一下网关开放的工作，通过一个叫做出校器的工具，选择一个运营商，将拨号所用的mac地址和相关的运营商进行绑定，此后的所有的数据包都发往指定运营商的网关，基于这个原理，可以在实验室等能够连通内网的设备上定期进行相关端口开放的工作(前提是将该设备的mac修改为路由器的mac地址)，另外，这里推荐一个师大师兄编写的mac、linux、windows下的第三方出校器和端口开放工具<a href="https://github.com/xuzhipengnt/ipclient_gxnu" title="ipclient_gxnu" target="_blank" rel="noopener">ipclient_gxnu</a>,项目中的有详细的介绍和文档，推荐学习。此外，如果仅仅是需要进行运营商和mac地址的绑定的话，推荐使用桂电某学生编写的在线端口绑定网站:<a href="http://sec.guet.edu.cn/open/" title="http://sec.guet.edu.cn/open/" target="_blank" rel="noopener">http://sec.guet.edu.cn/open/</a>将路由mac地址和某运营商端口进行绑定</p>
<h2 id="ubuntu发行版本选择"><a href="#ubuntu发行版本选择" class="headerlink" title="ubuntu发行版本选择"></a>ubuntu发行版本选择</h2><p>由于之前我用的是ubuntu的最新的发行版本，在dhcp的时候经常会出现三个默认路由的情况，我也没有深入研究原因，后来换到16.04LTS上后，同样的配置，dhcp后默认只有一个默认路由，所以推荐16.04LTS</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>安装pptpd<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install pptpd</span><br></pre></td></tr></table></figure></p>
<p><del>配置虚拟ip，编辑/etc/pptpd.conf</del> ( <em>这一步可以不用做，因为python脚本中会覆盖</em> ):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localip 10.20.39.111 # 本机ip</span><br><span class="line">remoteip 10.100.123.2-100 # 分配的ip段</span><br></pre></td></tr></table></figure></p>
<p>在/etc/ppp/pptpd-options下中设置dns:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#根据实际情况设置dns</span><br><span class="line">ms-dns 192.168.199.1</span><br><span class="line">ms-dns 114.114.114.114</span><br></pre></td></tr></table></figure></p>
<p>在/etc/ppp/chap-secrets中配置vpn账号:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;user&quot;  pptpd   &quot;user&quot;  * #星号是不限制ip的意思</span><br></pre></td></tr></table></figure></p>
<p>不过默认情况下，pptpd无法给vpn连接分配ip，所以如果是多用户的话需要手动分配ip具体配置类似:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;user1&quot;   pptpd   &quot;user1&quot;   10.100.123.2</span><br><span class="line">&quot;user2&quot;   pptpd   &quot;user2&quot;   10.100.123.3</span><br></pre></td></tr></table></figure></p>
<p>重启pptpd服务:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/pptpd restart</span><br></pre></td></tr></table></figure></p>
<p>在/etc/sysctl.conf中配置ip转发(取消该行注释):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure></p>
<p>使配置立即生效:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>安装iptables,这个是用于配置NAT映射的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install iptables</span><br></pre></td></tr></table></figure></p>
<p>建立一个外网NAT（外网走无线）:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -t nat -A POSTROUTING -s 10.100.123.0/24 -o wlo1 -j MASQUERADE</span><br></pre></td></tr></table></figure></p>
<p>建立一个内网NAT（内网走有线）:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -t nat -A POSTROUTING -s 10.100.123.0/24 -d 172.16.0.0/16 -o eno1 -j MASQUERADE</span><br></pre></td></tr></table></figure></p>
<p>其中-o参数配置的是流量的出口,也就是我这的外网出口<br>设置MTU,防止包过大而丢包:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A FORWARD -s 10.100.123.0/24 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1200</span><br></pre></td></tr></table></figure></p>
<p>保存规则(此处需要root权限):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables-save &gt;/etc/iptables-rules</span><br></pre></td></tr></table></figure></p>
<p>编辑/etc/network/interfaces,在末尾加一行,使网卡加载时自动加载规则:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">per-up iptables-restore &lt;/etc/iptables-rules</span><br></pre></td></tr></table></figure></p>
<p>配置到此为止</p>
<h2 id="网卡名称修改问题"><a href="#网卡名称修改问题" class="headerlink" title="网卡名称修改问题"></a>网卡名称修改问题</h2><p>新版的ubuntu网卡名称都是随机的，可以自定义修改网卡的名称，比如本文章中，有线网卡为:wlo1， 无线网卡为:eno1。<br>默认，/etc/udev/rules.d/只有一个README文件。<br>新建了70-persistent-net.rules文件，然后编辑：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, ATTR&#123;address&#125;==&quot;44:33:4c:07:ad:48&quot;, NAME=&quot;eno1&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="服务器启动代码"><a href="#服务器启动代码" class="headerlink" title="服务器启动代码"></a>服务器启动代码</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><ol>
<li>修改dhcp后的ip为静态ip</li>
<li>添加内外网路由，默认情况下重启后路由表会丢失</li>
<li>持续ping对方网关，保证服务器的稳定，推荐使用tmux来维持会话状态，保证程序存活</li>
</ol>
<h3 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h3><p>安装 <code>nodejs</code> 和 <code>npm</code> :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nodejs npm</span><br></pre></td></tr></table></figure></p>
<p>切换到 <code>/usr/bin</code> 目录下，建立一个 <code>node</code> 到 <code>nodejs</code> 的软连接，因为 <code>pm2</code> 启动时需要执行 <code>node</code> 命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/bin</span><br><span class="line">sudo ln -s ./node.js node</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>npm</code> 安装 <code>pm2</code> :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g pm2</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>pm2</code> 启动项目，并将其加入开启自启中:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd vpn_launch</span><br><span class="line">pm2 start ./launch.py --name=&quot;vpn&quot;</span><br><span class="line">pm2 save</span><br><span class="line">pm2 startup</span><br></pre></td></tr></table></figure></p>
<p>至此，您的pc、树莓派已经具有了开机自启、daemon、线路自检等功能，理论上已经不会掉线<br>代码地址:<a href="https://github.com/leftjs/vpn_launch" title="leftjs/vpn_launch" target="_blank" rel="noopener">leftjs/vpn_launch</a></p>
<p>launch.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket, fcntl, struct</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三方 SMTP 服务</span></span><br><span class="line">mail_host=<span class="string">"smtp.qq.com"</span>  <span class="comment">#设置服务器</span></span><br><span class="line">mail_user=<span class="string">"leftjs@foxmail.com"</span>    <span class="comment">#用户名</span></span><br><span class="line">mail_pass=<span class="string">"xxxx"</span>   <span class="comment">#授权口令</span></span><br><span class="line">sender = <span class="string">'leftjs@foxmail.com'</span></span><br><span class="line">receivers = [<span class="string">'lefttjs@gmail.com'</span>]  <span class="comment"># 接收邮件，可设置为你的QQ邮箱或者其他邮箱</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span><span class="params">(text)</span>:</span></span><br><span class="line">    message = MIMEText(<span class="string">'%s'</span> % text, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>)</span><br><span class="line">    message[<span class="string">'From'</span>] = Header(<span class="string">"leftjs"</span>, <span class="string">'utf-8'</span>)</span><br><span class="line">    message[<span class="string">'To'</span>] =  Header(<span class="string">"jason zhang"</span>, <span class="string">'utf-8'</span>)</span><br><span class="line">    subject = <span class="string">'vpn 报告'</span></span><br><span class="line">    message[<span class="string">'Subject'</span>] = Header(subject, <span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        smtpObj = smtplib.SMTP_SSL()</span><br><span class="line">        smtpObj.connect(mail_host, <span class="number">465</span>)    <span class="comment"># 25 为 SMTP 端口号</span></span><br><span class="line">        smtpObj.login(mail_user,mail_pass)</span><br><span class="line">        smtpObj.sendmail(sender, receivers, message.as_string())</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"邮件发送成功"</span></span><br><span class="line">    <span class="keyword">except</span> smtplib.SMTPException:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error: 无法发送邮件"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_local_ip</span><span class="params">(ifname)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        inet = fcntl.ioctl(s.fileno(), <span class="number">0x8915</span>, struct.pack(<span class="string">'256s'</span>, ifname[:<span class="number">15</span>]))</span><br><span class="line">        <span class="keyword">return</span> socket.inet_ntoa(inet[<span class="number">20</span>:<span class="number">24</span>])</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        send_email(str(e))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_ping</span><span class="params">()</span>:</span></span><br><span class="line">    (ping_state, res) = commands.getstatusoutput(<span class="string">'ping 202.193.75.254 -c 2'</span>)</span><br><span class="line">    <span class="comment"># (ping_state_baidu, res_baidu) = commands.getstatusoutput('ping www.baidu.com -c 2')</span></span><br><span class="line">    <span class="comment"># ping_state == 0 when ping is ok</span></span><br><span class="line">    <span class="comment"># return True if ping_state == 0 and ping_state_baidu == 0 else False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span> <span class="keyword">if</span> ping_state == <span class="number">0</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file_content</span><span class="params">(file_name)</span>:</span></span><br><span class="line">    the_file = open(file_name, <span class="string">'r'</span>)</span><br><span class="line">    file_content = the_file.read()</span><br><span class="line">    the_file.close()</span><br><span class="line">    <span class="keyword">return</span> file_content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_file_content</span><span class="params">(file_name, new_content)</span>:</span></span><br><span class="line">    out_file = open(file_name, <span class="string">'w'</span>)</span><br><span class="line">    out_file.write(new_content)</span><br><span class="line">    out_file.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_interfaces_static_file</span><span class="params">(intranet_ip)</span>:</span></span><br><span class="line">    raw_content = read_file_content(<span class="string">'./interfaces/raw_interfaces_static'</span>)</span><br><span class="line">    write_file_content(<span class="string">'./interfaces/interfaces_static'</span>, raw_content % intranet_ip)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restart_pptpd</span><span class="params">(intranet_ip)</span>:</span></span><br><span class="line">    raw_content = read_file_content(<span class="string">'./pptpd/raw_pptpd.conf'</span>)</span><br><span class="line">    write_file_content(<span class="string">'./pptpd/pptpd.conf'</span>, raw_content % intranet_ip)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'cp -f ./pptpd/pptpd.conf /etc/pptpd.conf'</span>)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'sudo /etc/init.d/pptpd restart'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restart_dnsmasq</span><span class="params">(intranet_ip)</span>:</span></span><br><span class="line">    raw_content = read_file_content(<span class="string">'./dns/raw_dnsmasq.conf'</span>)</span><br><span class="line">    write_file_content(<span class="string">'./dns/dnsmasq.conf'</span>, raw_content % intranet_ip)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'cp -f ./dns/dnsmasq.conf /etc/dnsmasq.conf'</span>)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'service dnsmasq restart'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_route_item</span><span class="params">()</span>:</span></span><br><span class="line">    commands.getstatusoutput(<span class="string">'ip route add 202.193.0.0/16 via 10.20.40.254 dev eno1'</span>)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'ip route add 10.100.123.0/24 via 10.20.40.254 dev eno1'</span>)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'ip route add 10.20.0.0/16 via 10.20.40.254 dev eno1'</span>)</span><br><span class="line">    commands.getstatusoutput(<span class="string">'ip route add 172.16.0.0/16 via 10.20.40.254 dev eno1'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    old_ip = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        ping_state = check_ping()</span><br><span class="line">        <span class="keyword">if</span> ping_state == <span class="keyword">False</span> <span class="keyword">or</span> old_ip == <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">print</span> time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>,time.localtime(time.time()))</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'network restart.'</span></span><br><span class="line">            commands.getstatusoutput(<span class="string">'dhclient eno1'</span>)</span><br><span class="line">            <span class="comment"># get new intranet ip</span></span><br><span class="line">            intranet_ip = get_local_ip(<span class="string">"eno1"</span>)</span><br><span class="line">            <span class="keyword">if</span> intranet_ip <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> old_ip == <span class="keyword">None</span> <span class="keyword">or</span> old_ip != intranet_ip:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'new ip: '</span>,intranet_ip</span><br><span class="line">                send_email(<span class="string">'新的ip为: %s'</span> % intranet_ip)</span><br><span class="line">                create_interfaces_static_file(intranet_ip)</span><br><span class="line">                restart_pptpd(intranet_ip)</span><br><span class="line">                <span class="comment"># restart_dnsmasq(intranet_ip)</span></span><br><span class="line">                old_ip = intranet_ip</span><br><span class="line">            commands.getstatusoutput(<span class="string">'cp -f ./interfaces/interfaces_static /etc/network/interfaces'</span>)</span><br><span class="line">            commands.getstatusoutput(<span class="string">'/etc/init.d/networking restart'</span>)</span><br><span class="line">            <span class="comment"># commands.getstatusoutput('dhclient eth0')</span></span><br><span class="line">            <span class="comment"># commands.getstatusoutput('cp -f ./dns/resolv.conf /etc/resolv.dnsmasq.conf')</span></span><br><span class="line">            add_route_item()</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'config complete.'</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="寝室ip扫描代码"><a href="#寝室ip扫描代码" class="headerlink" title="寝室ip扫描代码"></a>寝室ip扫描代码</h2><p>在实验室连入校内网批量ping宿舍ip，找出自己的主机。</p>
<p>ping_test.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line">num_threads = <span class="number">100</span></span><br><span class="line">queue = Queue()</span><br><span class="line">ips = [<span class="string">'10.20.38.'</span> + str(a) <span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">255</span>)] + [<span class="string">'10.20.39.'</span> + str(a) <span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">255</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">#wraps system ping command</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pinger</span><span class="params">(i, q)</span>:</span></span><br><span class="line">    <span class="string">"""Pings subnet"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        ip = q.get()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Thread %s: Pinging %s"</span> % (i, ip)</span><br><span class="line">        ret = subprocess.call(<span class="string">"ping -c 1 %s"</span> % ip,</span><br><span class="line">            shell=<span class="keyword">True</span>,</span><br><span class="line">            stdout=open(<span class="string">'/dev/null'</span>, <span class="string">'w'</span>),</span><br><span class="line">            stderr=subprocess.STDOUT)</span><br><span class="line">        <span class="keyword">if</span> ret == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"%s: is alive"</span> % ip</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'./result.txt'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="string">"%s: is alive\n"</span> % ip)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"%s: did not respond"</span> % ip</span><br><span class="line">        q.task_done()</span><br><span class="line"><span class="comment">#Spawn thread pool</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(num_threads):</span><br><span class="line">    worker = Thread(target=pinger, args=(i, queue))</span><br><span class="line">    worker.setDaemon(<span class="keyword">True</span>)</span><br><span class="line">    worker.start()</span><br><span class="line"><span class="comment">#Place work in queue</span></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line">    queue.put(ip)</span><br><span class="line"><span class="comment">#Wait until worker threads are done to exit</span></span><br><span class="line">queue.join()</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Jason Zhang" />
            
              <p class="site-author-name" itemprop="name">Jason Zhang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Zhang</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
